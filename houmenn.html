<!DOCTYPE html>
<html>
<head>
    <title>Interactive Map with API</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; }
        table { margin-top: 20px; border-collapse: collapse; }
        th, td { padding: 5px; text-align: center; border: 1px solid #ccc; }
        .blue-bg { background-color: lightblue; }
        .red-bg { background-color: lightcoral; }
        #keyInputContainer { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div id="keyInputContainer">
        <label for="apiKey">Enter API Key:</label>
        <input type="text" id="apiKey" placeholder="Enter key (e.g., 9999)">
        <button onclick="updatePins()">Load Data</button>
    </div>
    <div id="map"></div>
    <table id="types">
        <!-- Table content -->
    </table>

    <!-- Scripts moved to the end of the body -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([34.6866, 135.5200], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        var markers = [];
        // Event handlers and function definitions
        document.querySelectorAll('.select-column').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                var column = this.getAttribute('data-column');
                var checked = this.checked;
                document.querySelectorAll(`.type[data-column="${column}"]`).forEach(cb => cb.checked = checked);
                updatePins();
            });
        });

        document.querySelectorAll('.select-row').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                var row = this.getAttribute('data-row');
                var checked = this.checked;
                document.querySelectorAll(`.type[data-row="${row}"]`).forEach(cb => cb.checked = checked);
                updatePins();
            });
        });

        document.querySelectorAll('.type').forEach(checkbox => {
            checkbox.addEventListener('change', updatePins);
        });

        map.on('moveend', updatePins);

        function getSelectedTypes() {
            return Array.from(document.querySelectorAll('.type:checked')).map(el => el.value).join('%2B');
        }

        function updatePins() {
            var center = map.getCenter();
            var types = getSelectedTypes();
            var key = document.getElementById('apiKey').value;
            var url = `https://1x9guheg37.execute-api.ap-northeast-1.amazonaws.com/default/houmennmap?lat=${center.lat}&lon=${center.lng}&type=${types}&key=${key}`;

            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            fetch(url).then(response => response.json()).then(data => {
                addPins(data);
            }).catch(error => console.error('Error fetching data:', error));
        }

        function addPins(data) {
            data.forEach(point => {
                var color = (point.type <= 6) ? 'blue' : 'red';
                var circleMarker = L.circleMarker([point.latitude, point.longitude], {
                    radius: 5,
                    fillColor: color,
                    color: color,
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                circleMarker.bindPopup(`ID: ${point.id}<br>Type: ${labels[point.type - 1]}<br>Distance: ${point.distance.toFixed(3)} km`);
markers.push(circleMarker);
});
}
</script>

</body>
</html>
